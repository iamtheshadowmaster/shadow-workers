---
import ChatVisual from '../visuals/ChatVisual.astro';
import SystemPromptVisual from '../visuals/SystemPromptVisual.astro';
import SlackNotificationVisual from '../visuals/SlackNotificationVisual.astro';
import IntegrationsVisual from '../visuals/IntegrationsVisual.astro';
---

<!-- Hidden containers for each visual that will be shown/hidden based on scroll -->
<div id="solo-visuals-container" style="display: none;">
  <div data-visual="chat"><ChatVisual /></div>
  <div data-visual="systemPrompt"><SystemPromptVisual /></div>
  <div data-visual="slackNotification"><SlackNotificationVisual /></div>
  <div data-visual="integrations"><IntegrationsVisual /></div>
</div>

<style>
  @keyframes float-1 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(30px, -30px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
  }

  @keyframes float-2 {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    33% { transform: translate(-45%, -55%) scale(1.15); }
    66% { transform: translate(-55%, -45%) scale(0.85); }
  }

  @keyframes float-3 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(-25px, 35px) scale(0.9); }
    66% { transform: translate(25px, -25px) scale(1.1); }
  }

  @keyframes float-4 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(20px, 20px) scale(1.05); }
    66% { transform: translate(-30px, -15px) scale(0.95); }
  }

  .animate-float-1 { animation: float-1 20s ease-in-out infinite; }
  .animate-float-2 { animation: float-2 25s ease-in-out infinite; }
  .animate-float-3 { animation: float-3 22s ease-in-out infinite; }
  .animate-float-4 { animation: float-4 18s ease-in-out infinite; }
</style>

<!-- Scroll container that creates the scroll distance -->
<div id="plan-section" class="relative bg-black" style="height: 400vh;">
  <!-- Fixed/sticky content -->
  <div id="plan-sticky" class="sticky top-0 min-h-screen flex items-center bg-black py-16">
    <div class="max-w-7xl mx-auto px-6 w-full">
      <!-- Title -->
      <div class="text-center mb-12">
        <div class="inline-flex items-center gap-2 px-4 py-2 bg-white rounded-full mb-6">
          <div class="w-2 h-2 rounded-full bg-blue-500"></div>
          <span class="text-sm font-medium text-black uppercase tracking-wider">Solo Mode</span>
        </div>
        <h2 class="text-xl md:text-3xl lg:text-4xl font-medium text-white mb-6 leading-tight tracking-tight">
          Zero setup. Instant value. Daily progress.
        </h2>
      </div>

      <div class="flex items-center gap-12">
        <!-- Left: Content -->
        <div class="flex-1 flex flex-col justify-between">
          <div id="step-content" class="transition-opacity duration-700 ease-out" style="will-change: opacity;">
            <!-- Step content will be dynamically shown here -->
          </div>

          <!-- Progress Indicator at bottom -->
          <div class="mt-12">
            <div class="flex items-center">
              <div class="step-indicator flex items-center" data-step="1">
                <div class="step-dot w-3 h-3 rounded-full transition-all duration-500 ease-out bg-white border-2 border-gray-600" style="will-change: background-color, border-color;"></div>
                <div class="step-line h-0.5 w-12 bg-gray-800 transition-all duration-500 ease-out" style="will-change: background-color;"></div>
              </div>
              <div class="step-indicator flex items-center" data-step="2">
                <div class="step-dot w-3 h-3 rounded-full transition-all duration-500 ease-out bg-white border-2 border-gray-600" style="will-change: background-color, border-color;"></div>
                <div class="step-line h-0.5 w-12 bg-gray-800 transition-all duration-500 ease-out" style="will-change: background-color;"></div>
              </div>
              <div class="step-indicator flex items-center" data-step="3">
                <div class="step-dot w-3 h-3 rounded-full transition-all duration-500 ease-out bg-white border-2 border-gray-600" style="will-change: background-color, border-color;"></div>
                <div class="step-line h-0.5 w-12 bg-gray-800 transition-all duration-500 ease-out" style="will-change: background-color;"></div>
              </div>
              <div class="step-indicator flex items-center" data-step="4">
                <div class="step-dot w-3 h-3 rounded-full transition-all duration-500 ease-out bg-white border-2 border-gray-600" style="will-change: background-color, border-color;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Screenshot -->
        <div class="flex-1 hidden lg:block">
          <div id="step-image" class="rounded-2xl bg-gradient-to-br from-purple-500/20 to-blue-500/20 aspect-[4/3] overflow-hidden transition-all duration-700 ease-out" style="will-change: contents;">
            <!-- Screenshot will be shown here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const steps = [
    {
      number: 1,
      title: "Instant onboarding",
      description: "Give Shadow your role, company URL and current biggest goal. Shadow starts gathering a comprehensive context, better than you ever would.",
      customRender: 'chat'
    },
    {
      number: 2,
      title: "Personal roadmap",
      description: "Shadow creates your personal system promptâ€”capturing your role, company context, and objectives into a strategic blueprint that persists across every conversation.",
      customRender: 'systemPrompt'
    },
    {
      number: 3,
      title: "Daily reality check",
      description: "Every morning, Shadow asks one targeted question about your goals. It's like having your smartest colleague tap you on the shoulder.",
      customRender: 'slackNotification'
    },
    {
      number: 4,
      title: "Connect your tools",
      description: "Connect Slack, Calendar, Gmail, Google Drive, Notion, GitHub, Salesforce, Linear and more so Shadow can read your patterns and help you work better.",
      customRender: 'integrations'
    }
  ];

  let currentStep = 0;

  function renderStep(index: number) {
    const step = steps[index];
    const contentDiv = document.getElementById('step-content');
    const imageDiv = document.getElementById('step-image');

    if (contentDiv) {
      contentDiv.innerHTML = `
        <div class="mb-4">
          <span class="text-sm font-medium text-gray-500">${step.number}/4</span>
        </div>
        <h3 class="text-3xl md:text-4xl font-bold text-white mb-6">
          ${step.title}
        </h3>
        <p class="text-xl text-gray-400 leading-relaxed max-w-xl">
          ${step.description}
        </p>
      `;
    }

    if (imageDiv) {
      // Get the pre-rendered visual from the container
      const visualsContainer = document.getElementById('solo-visuals-container');
      const visualElement = visualsContainer?.querySelector(`[data-visual="${step.customRender}"]`);

      if (visualElement) {
        imageDiv.innerHTML = visualElement.innerHTML;
      }
    }

    // Update progress indicators
    document.querySelectorAll('.step-indicator').forEach((indicator, i) => {
      const stepDot = indicator.querySelector('.step-dot');
      const stepLine = indicator.querySelector('.step-line');

      if (i < index) {
        // Completed steps
        stepDot?.classList.remove('bg-white', 'border-gray-600');
        stepDot?.classList.add('bg-black', 'border-white');
        stepLine?.classList.remove('bg-gray-800');
        stepLine?.classList.add('bg-white');
      } else if (i === index) {
        // Current step
        stepDot?.classList.remove('bg-white', 'border-gray-600');
        stepDot?.classList.add('bg-black', 'border-white');
        stepLine?.classList.remove('bg-white');
        stepLine?.classList.add('bg-gray-800');
      } else {
        // Future steps
        stepDot?.classList.remove('bg-black', 'border-white');
        stepDot?.classList.add('bg-white', 'border-gray-600');
        stepLine?.classList.remove('bg-white');
        stepLine?.classList.add('bg-gray-800');
      }
    });
  }

  let rafId: number | null = null;
  let ticking = false;

  function updateStepBasedOnScroll() {
    const section = document.getElementById('plan-section') as HTMLElement;
    if (!section) return;

    const rect = section.getBoundingClientRect();
    const sectionHeight = section.offsetHeight;
    const viewportHeight = window.innerHeight;

    // Calculate scroll progress through the section (0 to 1)
    const scrollProgress = Math.max(0, Math.min(1, -rect.top / (sectionHeight - viewportHeight)));

    // Determine which step to show (0-3)
    const newStep = Math.min(3, Math.floor(scrollProgress * 4));

    // Update step
    if (newStep !== currentStep) {
      currentStep = newStep;
      renderStep(currentStep);
    }

    ticking = false;
  }

  function requestUpdate() {
    if (!ticking) {
      rafId = requestAnimationFrame(updateStepBasedOnScroll);
      ticking = true;
    }
  }

  // Initialize
  renderStep(0);

  // Update on scroll with RAF
  window.addEventListener('scroll', requestUpdate, { passive: true });
  // Initial update
  updateStepBasedOnScroll();
</script>
