---
import Layout from '../layouts/Layout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
// Remove the server-side import as we'll use client-side only
// import { supabase } from '../lib/supabase';
---

<Layout title="Apply - Shadow">
  <Nav />
  <main class="min-h-screen bg-black pt-24">
    <div class="mx-auto max-w-7xl px-6 lg:px-8 py-12">
      <div class="mx-auto max-w-2xl">
        <div class="text-center mb-16">
          <h1 class="text-left text-3xl font-bold tracking-tight text-white sm:text-4xl">
            Join our founding waitlist
          </h1>
        </div>

        <form id="applicationForm" class="space-y-8">

                    <!-- Progress bar -->
                    <div class="relative pt-1">
                      <div class="flex justify-between pb-2">
                        <span class="step-indicator text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-gray-700">Hey</span>
                        <span class="step-indicator text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-gray-500 bg-gray-700">You</span>
                        <span class="step-indicator text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-gray-500 bg-gray-700">Get</span>
                        <span class="step-indicator text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-gray-500 bg-gray-700">Work</span>
                        <span class="step-indicator text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-gray-500 bg-gray-700">Done</span>
                      </div>
                      <div class="flex mb-2 items-center justify-between">
                        <div class="flex-1">
                          <div class="relative h-2 rounded-full overflow-hidden bg-gray-700">
                            <div class="progress-bar w-0 h-full bg-shadow-blue transition-all duration-300 ease-in-out"></div>
                          </div>
                        </div>
                      </div>
                    </div>

          <!-- Step 0: Introduction -->
          <div id="step0" class="form-step">
            <div class="text-left mb-8">
              <h3 class="text-xl font-semibold text-white mb-4">Modern Achievers,</h3>
              <p class="text-gray-300">
                AI is changing the way we work. Top performers will get more done. Shadow is the platform for these top performers to get more done. Join the waitlist now.
              </p>
            </div>
          </div>

          <!-- Step 1: Job Position -->
          <div id="step1" class="form-step hidden">
            <div class="grid grid-cols-1 gap-x-8 gap-y-6 sm:grid-cols-2">
              <div class="sm:col-span-2">
                <label for="email" class="block text-sm font-medium leading-6 text-white">
                  Email address
                </label>
                <div class="mt-2">
                  <input
                    type="email"
                    name="email"
                    id="email"
                    required
                    placeholder="firstname.lastname@company.com"
                    class="block w-full rounded-md border-0 bg-white/5 px-3.5 py-2 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-cyan-500 sm:text-sm sm:leading-6"
                  />
                </div>
              </div>

              <div class="sm:col-span-2">
                <label for="company" class="block text-sm font-medium leading-6 text-white">
                  Company name
                </label>
                <div class="mt-2">
                  <input
                    type="text"
                    name="company"
                    id="company"
                    required
                    placeholder="Your company name"
                    class="block w-full rounded-md border-0 bg-white/5 px-3.5 py-2 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-cyan-500 sm:text-sm sm:leading-6"
                  />
                </div>
              </div>

              <div class="sm:col-span-2">
                <label for="position" class="block text-sm font-medium leading-6 text-white">
                  Position
                </label>
                <div class="mt-2">
                  <select
                    id="position"
                    name="position"
                    required
                    class="block w-full rounded-md border-0 bg-white/5 px-3.5 py-2 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-cyan-500 sm:text-sm sm:leading-6"
                  >
                    <option value="">Select your position</option>
                    <option value="Product Manager">Product Manager</option>
                    <option value="Account Manager">Account Manager</option>
                    <option value="Account Executive">Account Executive</option>
                    <option value="Customer Success Manager">Customer Success Manager</option>
                    <option value="Founder">Founder</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>

              <div id="otherPositionContainer" class="sm:col-span-2 hidden">
                <label for="otherPosition" class="block text-sm font-medium leading-6 text-white">
                  Please specify your position
                </label>
                <div class="mt-2">
                  <input
                    type="text"
                    name="otherPosition"
                    id="otherPosition"
                    placeholder="Your position"
                    class="block w-full rounded-md border-0 bg-white/5 px-3.5 py-2 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-cyan-500 sm:text-sm sm:leading-6"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Tools -->
          <div id="step2" class="form-step hidden">
            <div class="space-y-6">
              <h3 class="text-lg font-medium text-white">What tools are you using?</h3>
              
              <div class="space-y-4">
                <div>
                  <div class="flex flex-wrap gap-3" id="toolChips">
                    <!-- Tool chips will be dynamically added here -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 3: Tasks Selection -->
          <div id="step3" class="form-step hidden">
            <div class="space-y-6">
              <h3 class="text-lg font-medium text-white">Tell us about your work</h3>
              <div>
                <label for="most-hated" class="block text-sm font-medium leading-6 text-white">
                  What do you hate doing the most?
                </label>
                <div class="mt-2">
                  <textarea
                    id="most-hated"
                    name="most_hated"
                    rows="3"
                    required
                    class="block w-full rounded-md border-0 bg-white/5 px-3.5 py-2 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-cyan-500 sm:text-sm sm:leading-6"
                  ></textarea>
                </div>
              </div>

              <div>
                <label for="time-consuming" class="block text-sm font-medium leading-6 text-white">
                  What feels like it should be easy, but takes forever?
                </label>
                <div class="mt-2">
                  <textarea
                    id="time-consuming"
                    name="time_consuming"
                    rows="3"
                    required
                    class="block w-full rounded-md border-0 bg-white/5 px-3.5 py-2 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-cyan-500 sm:text-sm sm:leading-6"
                  ></textarea>
                </div>
              </div>

              <div>
                <label for="shadow-fix" class="block text-sm font-medium leading-6 text-white">
                  If someone could shadow you today, what would you ask them to fix first?
                </label>
                <div class="mt-2">
                  <textarea
                    id="shadow-fix"
                    name="shadow_fix"
                    rows="3"
                    required
                    class="block w-full rounded-md border-0 bg-white/5 px-3.5 py-2 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-cyan-500 sm:text-sm sm:leading-6"
                  ></textarea>
                </div>
              </div>

              <div>
                <label for="not-doing" class="block text-sm font-medium leading-6 text-white">
                  What should you be doing, but you don't (because of time, laziness,...)?
                </label>
                <div class="mt-2">
                  <textarea
                    id="not-doing"
                    name="not_doing"
                    rows="3"
                    required
                    class="block w-full rounded-md border-0 bg-white/5 px-3.5 py-2 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-cyan-500 sm:text-sm sm:leading-6"
                  ></textarea>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Step 4: Submit -->
          <div id="step4" class="form-step hidden">
            <div class="text-left mb-8">
              <h3 class="text-xl font-semibold text-white mb-4">Boom, done!</h3>
              <p class="text-gray-300">
                Thanks for your time. We'll put some thought into it and get back to you when we think we can get you 10x more productive.
              </p>
              
              <!-- Share section -->
              <div class="mt-10">
                <h4 class="text-lg font-medium text-white mb-4">Share with a friend</h4>
                <p class="text-gray-400 text-sm mb-6">Know someone who would benefit from Shadow? Share it privately:</p>
                
                <div class="flex justify-left">
                  <!-- WhatsApp sharing -->
                  <a href="#" id="shareWhatsApp" class="share-button">
                    <div class="flex flex-col items-center">
                      <div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                        </svg>
                      </div>
                      <span class="text-sm text-gray-300 mt-2">WhatsApp</span>
                    </div>
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Navigation buttons -->
          <div class="flex justify-between mt-8" id="navigationButtons">
            <div>
              <button
                type="button"
                id="prevButton"
                class="hidden rounded-full bg-gray-600 px-3.5 py-2 text-md font-semibold text-white shadow-sm hover:bg-opacity-90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-600"
              >
                Previous
              </button>
            </div>
            <div>
              <button
                type="button"
                id="nextStep"
                class="rounded-full bg-shadow-blue px-3.5 py-2 text-md font-semibold text-white shadow-sm hover:bg-opacity-90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-shadow-blue"
              >
                Next
              </button>
            </div>
            <button
              type="submit"
              id="submitButton"
              class="hidden rounded-full bg-shadow-blue px-3.5 py-2 text-md font-semibold text-white shadow-sm hover:bg-opacity-90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-shadow-blue"
            >
              Submit
            </button>
          </div>
          <div id="formMessage" class="mt-4 text-center text-sm"></div>
        </form>
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<style>
  .magic-button {
    background: transparent;
    position: relative;
    padding: 1.5px;
    border-radius: 4px;
    background: linear-gradient(45deg, #3B82F6, #F43F5E, #FFFFFF);
  }
  .magic-button span {
    display: flex;
    align-items: center;
    justify-content: center;
    background: black;
    border-radius: 3.5px;
    padding: 4px;
    height: 100%;
    width: 100%;
  }
  .magic-button:hover span {
    background: linear-gradient(45deg, #3B82F610, #F43F5E10, #FFFFFF10);
  }

  .task-chip input[type="checkbox"]:checked + span {
    background: linear-gradient(45deg, #3B82F6, #F43F5E);
    color: white;
    padding-right: 2.5rem;
  }
  .task-chip input[type="checkbox"]:checked + span::after {
    content: '✓';
    position: absolute;
    right: 1rem;
    opacity: 1;
  }
  .task-chip span {
    position: relative;
    transition: all 0.2s ease-in-out;
  }
  .task-chip:hover span {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  /* Success animation styles */
  .success-animation {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  .checkmark {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: block;
    stroke-width: 2;
    stroke: #3B82F6;
    stroke-miterlimit: 10;
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
    animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
  }
  
  .checkmark__circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 2;
    stroke-miterlimit: 10;
    stroke: #3B82F6;
    fill: none;
    animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
  }
  
  .checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
  }
  
  @keyframes stroke {
    100% {
      stroke-dashoffset: 0;
    }
  }
  
  @keyframes scale {
    0%, 100% {
      transform: none;
    }
    50% {
      transform: scale3d(1.1, 1.1, 1);
    }
  }
  
  @keyframes fill {
    100% {
      box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
    }
  }
  
  .success-title {
    animation: fadeInUp 0.8s ease-in-out 0.5s forwards;
    opacity: 0;
    transform: translateY(20px);
  }
  
  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Share buttons styles */
  .share-button {
    transition: transform 0.3s ease;
  }
  
  .share-button:hover {
    transform: translateY(-5px);
  }
</style>

<script>
  // Import Supabase client directly in the client-side script
  import { createClient } from '@supabase/supabase-js';

  // Initialize Supabase client
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  // Form elements
  const form = document.getElementById('applicationForm') as HTMLFormElement;
  const messageDiv = document.getElementById('formMessage');
  const positionSelect = document.getElementById('position') as HTMLSelectElement;
  const otherPositionContainer = document.getElementById('otherPositionContainer');
  const otherPositionInput = document.getElementById('otherPosition') as HTMLInputElement;

  // Placeholders for text areas by position
  const placeholders = {
    'Product Manager': {
      'most-hated': [
        "Creating weekly status reports from multiple sources",
        "Manually updating project timelines across tools",
        "Collecting and organizing feedback from stakeholders",
        "Documenting feature requirements repeatedly"
      ],
      'time-consuming': [
        "Finding the right information in old email threads",
        "Getting updates from team members for project status",
        "Prioritizing feature requests from different stakeholders",
        "Creating presentations for executive reviews"
      ],
      'shadow-fix': [
        "Automate our sprint reporting process",
        "Create a better system for tracking feature requests",
        "Streamline our user feedback collection",
        "Improve our product documentation workflow"
      ],
      'not-doing': [
        "Regular competitive analysis",
        "Documenting product decisions and rationales",
        "Analyzing product usage metrics",
        "Keeping our product roadmap up to date"
      ]
    },
    'Account Manager': {
      'most-hated': [
        "Manual data entry from emails into our CRM",
        "Creating client reports from multiple data sources",
        "Following up on unanswered client emails",
        "Scheduling meetings with multiple stakeholders"
      ],
      'time-consuming': [
        "Finding client information across different platforms",
        "Preparing for client review meetings",
        "Formatting client-facing documents",
        "Tracking client requests and action items"
      ],
      'shadow-fix': [
        "Automate our client onboarding process",
        "Create a better system for tracking client requests",
        "Streamline our client communication workflow",
        "Improve our client reporting process"
      ],
      'not-doing': [
        "Regular check-ins with all clients",
        "Documenting client interactions thoroughly",
        "Analyzing client satisfaction data",
        "Proactive outreach to at-risk accounts"
      ]
    },
    'Account Executive': {
      'most-hated': [
        "Manually logging sales activities in CRM",
        "Creating custom sales proposals",
        "Following up with prospects who went cold",
        "Scheduling demos across different time zones"
      ],
      'time-consuming': [
        "Finding relevant information for prospect questions",
        "Preparing for sales calls and demos",
        "Customizing pitch decks for different industries",
        "Tracking deal progress and next steps"
      ],
      'shadow-fix': [
        "Automate our prospect follow-up process",
        "Create a better system for tracking sales opportunities",
        "Streamline our proposal creation workflow",
        "Improve our demo scheduling process"
      ],
      'not-doing': [
        "Regular prospecting to fill the pipeline",
        "Documenting sales calls and customer objections",
        "Analyzing win/loss patterns",
        "Keeping our competitive intelligence up to date"
      ]
    },
    'Customer Success Manager': {
      'most-hated': [
        "Creating customer health reports manually",
        "Tracking customer issues across multiple tools",
        "Following up on customer support tickets",
        "Scheduling training sessions with customers"
      ],
      'time-consuming': [
        "Finding customer information across different platforms",
        "Preparing for customer review meetings",
        "Creating custom reports for customers",
        "Tracking customer success metrics"
      ],
      'shadow-fix': [
        "Automate our customer health monitoring",
        "Create a better system for tracking customer issues",
        "Streamline our customer onboarding workflow",
        "Improve our customer training process"
      ],
      'not-doing': [
        "Regular proactive check-ins with all customers",
        "Documenting customer success stories",
        "Analyzing customer usage patterns",
        "Creating self-service resources for customers"
      ]
    },
    'Founder': {
      'most-hated': [
        "Managing my overflowing inbox",
        "Creating investor updates and reports",
        "Following up on partnership opportunities",
        "Scheduling meetings with potential clients/investors"
      ],
      'time-consuming': [
        "Finding information scattered across tools and emails",
        "Preparing for investor and board meetings",
        "Switching context between different business areas",
        "Tracking company KPIs from multiple sources"
      ],
      'shadow-fix': [
        "Automate our investor reporting process",
        "Create a better system for tracking company priorities",
        "Streamline our hiring and onboarding workflow",
        "Improve our financial reporting process"
      ],
      'not-doing': [
        "Regular strategic planning sessions",
        "Documenting company processes and procedures",
        "Analyzing market trends and opportunities",
        "Keeping our company wiki up to date"
      ]
    },
    'default': {
      'most-hated': [
        "Manual data entry from emails into our systems",
        "Creating reports from multiple sources",
        "Following up on unanswered emails",
        "Scheduling meetings across different time zones"
      ],
      'time-consuming': [
        "Finding the right information in old email threads",
        "Getting updates from team members for project status",
        "Formatting documents to match company guidelines",
        "Organizing meeting notes and action items"
      ],
      'shadow-fix': [
        "Automate our most repetitive processes",
        "Create a better system for tracking tasks",
        "Streamline our communication workflow",
        "Improve our meeting scheduling process"
      ],
      'not-doing': [
        "Regular follow-ups with important contacts",
        "Documenting processes and procedures",
        "Analyzing relevant data for insights",
        "Keeping our knowledge base up to date"
      ]
    }
  };

  // Function to animate text character by character
  async function animateText(textarea: HTMLTextAreaElement, text: string) {
    let currentText = '';
    for (let i = 0; i < text.length; i++) {
      currentText += text[i];
      textarea.placeholder = currentText;
      await new Promise(resolve => setTimeout(resolve, 50));
    }
    return true; // Return true when animation is complete
  }

  // Store the current placeholder index for each textarea
  const currentPlaceholderIndices = {};

  // Function to set placeholder with animation and cycle through all options
  function setRandomPlaceholder(textareaId: string, index: number = 0) {
    const textarea = document.getElementById(textareaId) as HTMLTextAreaElement;
    if (!textarea) return;
    
    // Get current position selection
    const currentPosition = positionSelect?.value || '';
    
    // Determine which placeholder set to use
    const positionKey = currentPosition && placeholders[currentPosition] ? currentPosition : 'default';
    
    if (placeholders[positionKey] && placeholders[positionKey][textareaId]) {
      const options = placeholders[positionKey][textareaId];
      
      // Initialize the index for this textarea if it doesn't exist
      if (!currentPlaceholderIndices[textareaId]) {
        currentPlaceholderIndices[textareaId] = 0;
      }
      
      // Get the next placeholder in sequence
      const placeholderIndex = currentPlaceholderIndices[textareaId];
      const newPlaceholder = options[placeholderIndex];
      
      // Update the index for next time, cycling back to 0 if we reach the end
      currentPlaceholderIndices[textareaId] = (placeholderIndex + 1) % options.length;
      
      return animateText(textarea, newPlaceholder);
    }
    return Promise.resolve(true);
  }

  // Function to animate placeholders sequentially
  async function animatePlaceholdersSequentially() {
    const textareaIds = Object.keys(placeholders['default']);
    
    for (let i = 0; i < textareaIds.length; i++) {
      await setRandomPlaceholder(textareaIds[i]);
    }
    
    // After all animations are done, schedule the next round
    setTimeout(animatePlaceholdersSequentially, 2000);
  }

  // Start the sequential animation
  animatePlaceholdersSequentially();
  
  // Reset placeholder indices when position changes
  positionSelect?.addEventListener('change', () => {
    // Reset all indices to start the animation from the beginning
    Object.keys(placeholders).forEach(id => {
      currentPlaceholderIndices[id] = 0;
    });
    // Update placeholders with the new position
    Object.keys(placeholders).forEach((id, index) => setRandomPlaceholder(id, index));
  });

  // Track if user has interacted with the form
  let formInteracted = false;

  // Add event listeners to track form interaction
  document.querySelectorAll('input, select, textarea').forEach(element => {
    element.addEventListener('input', () => {
      formInteracted = true;
    });
    element.addEventListener('change', () => {
      formInteracted = true;
    });
    element.addEventListener('focus', () => {
      formInteracted = true;
    });
  });
  
  // Navigation elements
  const prevButton = document.getElementById('prevButton');
  const nextButton = document.getElementById('nextStep');
  const submitButton = document.getElementById('submitButton');
  const progressBar = document.querySelector('.progress-bar') as HTMLElement;
  const stepIndicators = document.querySelectorAll('.step-indicator');

  // Form steps
  const formSteps = document.querySelectorAll('.form-step');
  let currentStep = 0;
  
  // Tool suggestions by position
  const toolSuggestions = {
    "Product Manager": ["Jira", "Asana", "Trello", "Notion", "Miro", "Figma", "Slack", "Zoom", "Whatsapp", "Microsoft Teams", "Confluence", "Amplitude", "Loom", "Mixpanel", "Pendo", "Aha!", "Typeform", "Hotjar", "Google Analytics", "Productboard", "Google Workspace", "Office 365", "ChatGPT", "Gemini for Workplace", "Claude", "NotebookLM", "v0", "Cursor", "Lovable", "Windsurf", "Trae", "Bolt", "Zapier", "Make.com", "N8N"],
    "Account Manager": ["Salesforce", "HubSpot", "Attio", "Pipedrive", "Monday.com", "Asana", "Slack", "Whatsapp", "Zoom", "Outreach", "LinkedIn Sales Navigator", "DocuSign", "Loom", "Calendly", "Gong", "SalesLoft", "ChatGPT", "Gemini for Workspace", "Claude"],
    "Account Executive": ["Salesforce", "HubSpot", "Attio", "Pipedrive", "Close", "Slack", "Zoom", "Outreach", "Whatsapp", "LinkedIn Sales Navigator", "Apollo", "Brevo", "DocuSign", "Loom", "Calendly", "Gong", "SalesLoft"],
    "Customer Success Manager": ["Planhat", "Gainsight", "Totango", "ChurnZero", "Salesforce", "Intercom", "Whatsapp", "Zendesk", "Front", "Help Scout", "Calendly", "Gong", "Customer.io", "Mixpanel"],
    "Founder": ["Notion", "Asana", "Trello", "GitHub", "Slack", "Zoom", "Discord", "LinkedIn", "Stripe", "QuickBooks", "Google Workspace", "Office 365", "Zapier", "Superhuman", "ChatGPT", "Gemini for Workspace", "Claude", "NotebookLM", "v0", "Cursor", "Lovable", "Windsurf", "Trae", "Bolt", "Zapier", "Make.com", "N8N", "Webflow", "Bubble", "Whatsapp"],
  };

  function createToolChip(tool) {
    const label = document.createElement('label');
    label.className = 'task-chip cursor-pointer';
    
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.name = 'tools';
    input.value = tool;
    input.className = 'hidden';
    
    const span = document.createElement('span');
    span.className = 'inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-white/5 text-white hover:bg-white/10 transition-colors relative';
    span.textContent = tool;

    // Add click handler to toggle selected state
    label.addEventListener('click', (e) => {
      e.preventDefault();
      input.checked = !input.checked;
      if (input.checked) {
        span.classList.add('bg-shadow-blue', 'text-white');
        span.style.paddingRight = '2.5rem';
        if (!span.querySelector('.checkmark')) {
          const checkmark = document.createElement('span');
          checkmark.className = 'checkmark';
          checkmark.textContent = '✓';
          checkmark.style.position = 'absolute';
          checkmark.style.right = '1rem';
          span.appendChild(checkmark);
        }
      } else {
        span.classList.remove('bg-shadow-blue', 'text-white');
        span.style.paddingRight = '1rem';
        const checkmark = span.querySelector('.checkmark');
        if (checkmark) {
          span.removeChild(checkmark);
        }
      }
    });
    
    label.appendChild(input);
    label.appendChild(span);
    return label;
  }

  // Handle position change
  positionSelect?.addEventListener('change', (e) => {
    const target = e.target as HTMLSelectElement;
    const toolChipsContainer = document.getElementById('toolChips');
    
    if (target.value === 'other') {
      otherPositionContainer?.classList.remove('hidden');
      otherPositionInput?.setAttribute('required', 'true');
      
      // Create a mixed set of tools for 'other' position
      if (toolChipsContainer) {
        toolChipsContainer.innerHTML = '';
        
        // Get all available positions except 'other'
        const positions = Object.keys(toolSuggestions);
        
        // Create a set to avoid duplicates
        const mixedToolsSet = new Set();
        
        // Add some tools from each position
        positions.forEach(position => {
          const positionTools = toolSuggestions[position];
          // Take a random selection of 3-5 tools from each position
          const numTools = Math.floor(Math.random() * 3) + 10; // 3-12 tools
          
          for (let i = 0; i < numTools && i < positionTools.length; i++) {
            // Get a random tool from this position
            const randomIndex = Math.floor(Math.random() * positionTools.length);
            mixedToolsSet.add(positionTools[randomIndex]);
          }
        });
        
        // Convert set to array and limit to a reasonable number (max 25)
        const mixedTools = Array.from(mixedToolsSet).slice(0, 25);
        
        // Add the mixed tools to the container
        mixedTools.forEach(tool => {
          toolChipsContainer.appendChild(createToolChip(tool as string));
        });
      }
    } else {
      otherPositionContainer?.classList.add('hidden');
      otherPositionInput?.removeAttribute('required');
      otherPositionInput.value = '';
      
      // Update tool suggestions
      if (toolChipsContainer && toolSuggestions[target.value]) {
        toolChipsContainer.innerHTML = '';
        toolSuggestions[target.value].forEach(tool => {
          toolChipsContainer.appendChild(createToolChip(tool));
        });
      }
      
      // Update placeholders based on new position
      Object.keys(placeholders['default']).forEach((id, index) => setRandomPlaceholder(id, index));
    }
  });

  // Navigation event listeners
  prevButton?.addEventListener('click', () => {
    if (currentStep > 0) {
      updateStep(currentStep - 1);
    }
  });

  nextButton?.addEventListener('click', async () => {
    if (validateStep(currentStep)) {
      // If we're on the last input step (step 3), submit the form data
      if (currentStep === 3) {
        await submitFormToSupabase();
      } else if (currentStep < formSteps.length - 1) {
        // Otherwise just go to the next step
        updateStep(currentStep + 1);
      }
    }
  });
  
  // Handle form submission via Supabase
  async function submitFormToSupabase() {
    if (!messageDiv) return;
    
    messageDiv.className = 'mt-4 text-center text-sm text-gray-300';
    messageDiv.textContent = 'Submitting your application...';

    const formData = new FormData(form);
    const selectedTools = Array.from(document.querySelectorAll('input[name="tools"]:checked')).map(cb => (cb as HTMLInputElement).value);
    
    try {
      const { error } = await supabase
        .from('waitlist')
        .insert({
          email: formData.get('email')?.toString().trim() || '',
          company: formData.get('company')?.toString().trim() || '',
          position: formData.get('position')?.toString().trim() || '',
          other_position: formData.get('otherPosition')?.toString().trim() || '',
          tools: selectedTools.join(', '),
          most_hated: formData.get('most_hated')?.toString().trim() || '',
          time_consuming: formData.get('time_consuming')?.toString().trim() || '',
          shadow_fix: formData.get('shadow_fix')?.toString().trim() || '',
          not_doing: formData.get('not_doing')?.toString().trim() || '',
          created_at: new Date().toISOString()
        });
      
      if (error) {
        if (error.code === '23505') { // Unique violation
          throw new Error('Email already registered');
        }
        throw new Error('Database error: ' + error.message);
      }

      messageDiv.textContent = ''; // Clear the message
      updateStep(4); // Move to the final step (step 4)
    } catch (error) {
      console.error("Submission error:", error);
      messageDiv.textContent = error instanceof Error ? error.message : 'Something went wrong. Please try again.';
      messageDiv.className = 'mt-4 text-center text-sm text-red-500';
    }
  }
  
  // No need to clone and replace buttons as we already have the correct references
  // We'll just use the original button references: prevButton, nextButton, and submitButton
  
  // Event listeners for navigation buttons are already defined above

  // Form submission handler
  form?.addEventListener('submit', (e) => {
    e.preventDefault();
  });

  // Function to validate the current step before proceeding
  function validateStep(step) {
    switch (step) {
      case 0: // Introduction step - no validation needed
        return true;
      case 1: // Job Position step
        const email = document.getElementById('email') as HTMLInputElement;
        const company = document.getElementById('company') as HTMLInputElement;
        const position = document.getElementById('position') as HTMLSelectElement;
        const otherPosition = document.getElementById('otherPosition') as HTMLInputElement;
        
        if (!email.value.trim()) {
          messageDiv.textContent = 'Please enter your email address';
          messageDiv.className = 'mt-4 text-center text-sm text-red-500';
          return false;
        }
        
        if (!company.value.trim()) {
          messageDiv.textContent = 'Please enter your company name';
          messageDiv.className = 'mt-4 text-center text-sm text-red-500';
          return false;
        }
        
        if (!position.value) {
          messageDiv.textContent = 'Please select your position';
          messageDiv.className = 'mt-4 text-center text-sm text-red-500';
          return false;
        }
        
        if (position.value === 'other' && !otherPosition.value.trim()) {
          messageDiv.textContent = 'Please specify your position';
          messageDiv.className = 'mt-4 text-center text-sm text-red-500';
          return false;
        }
        
        messageDiv.textContent = '';
        return true;
        
      case 2: // Tools step - no required validation
        return true;
        
      case 3: // Tasks Selection step
        const mostHated = document.getElementById('most-hated') as HTMLTextAreaElement;
        const timeConsuming = document.getElementById('time-consuming') as HTMLTextAreaElement;
        const shadowFix = document.getElementById('shadow-fix') as HTMLTextAreaElement;
        const notDoing = document.getElementById('not-doing') as HTMLTextAreaElement;
        
        if (!mostHated.value.trim()) {
          messageDiv.textContent = 'Please tell us what you hate doing the most';
          messageDiv.className = 'mt-4 text-center text-sm text-red-500';
          return false;
        }
        
        if (!timeConsuming.value.trim()) {
          messageDiv.textContent = 'Please tell us what takes forever';
          messageDiv.className = 'mt-4 text-center text-sm text-red-500';
          return false;
        }
        
        if (!shadowFix.value.trim()) {
          messageDiv.textContent = 'Please tell us what you would ask someone to fix first';
          messageDiv.className = 'mt-4 text-center text-sm text-red-500';
          return false;
        }
        
        if (!notDoing.value.trim()) {
          messageDiv.textContent = 'Please tell us what you should be doing but are not';
          messageDiv.className = 'mt-4 text-center text-sm text-red-500';
          return false;
        }
        
        messageDiv.textContent = '';
        return true;
        
      default:
        return true;
    }
  }
  
  // Function to update the form step
  function updateStep(step) {
    // Hide all steps
    formSteps.forEach((stepElement, index) => {
      stepElement.classList.add('hidden');
      if (stepIndicators[index]) {
        stepIndicators[index].classList.remove('text-white');
        stepIndicators[index].classList.add('text-gray-500');
      }
    });
    
    // Show the current step
    if (formSteps[step]) {
      formSteps[step].classList.remove('hidden');
      if (stepIndicators[step]) {
        stepIndicators[step].classList.remove('text-gray-500');
        stepIndicators[step].classList.add('text-white');
      }
    }
    
    // Update progress bar
    if (progressBar) {
      const progress = (step / (formSteps.length - 1)) * 100;
      progressBar.style.width = `${progress}%`;
    }
    
    // Update navigation buttons
    if (prevButton) {
      if (step > 0 && step !== 4) {
        prevButton.classList.remove('hidden');
      } else {
        prevButton.classList.add('hidden');
      }
    }
    
    if (nextButton && submitButton) {
      if (step === 3) { // Last input step
        nextButton.textContent = 'Submit';
      } else {
        nextButton.textContent = 'Next';
      }
      
      if (step === 4) { // Thank you step
        nextButton.classList.add('hidden');
        submitButton.classList.add('hidden');
      } else {
        nextButton.classList.remove('hidden');
        submitButton.classList.add('hidden');
      }
    }
    
    currentStep = step;
  }

  // Initialize the form
  updateStep(0);
  
  // Set up WhatsApp sharing functionality
  const shareWhatsAppButton = document.getElementById('shareWhatsApp');
  shareWhatsAppButton?.addEventListener('click', (e) => {
    e.preventDefault();
    const text = encodeURIComponent('Check out Shadow - a platform that helps you get 10x more done: https://shadow.com');
    window.open(`https://wa.me/?text=${text}`, '_blank');
  });
  </script>
