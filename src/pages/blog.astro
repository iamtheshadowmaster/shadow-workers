---
import Layout from '../layouts/Layout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro'
import { getCollection } from 'astro:content';

// Get all blog posts and sort by date (newest first)
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Get unique categories
const categories = ['All Posts', ...Array.from(new Set(allPosts.map(post => post.data.category)))];

// Format date helper
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  }).format(date);
};
---

<Layout>
  <Nav />

  <main class="min-h-screen bg-black pt-40 pb-16">
    <div class="mx-auto px-6 lg:px-8" style="max-width: 1000px;">
      <div class="flex flex-col lg:flex-row gap-12">
        <!-- Sidebar -->
        <aside class="lg:w-64 flex-shrink-0">
          <h1 class="text-5xl font-bold text-white mb-12">Blog</h1>

          <nav class="space-y-2">
            {categories.map((category) => (
              <button
                class="category-filter w-full text-left px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-200"
                data-category={category}
              >
                {category}
              </button>
            ))}
          </nav>
        </aside>

        <!-- Blog Posts Grid -->
        <div class="flex-1">
          <div class="grid gap-6">
            {sortedPosts.map((post) => (
              <a
                href={`/blog/${post.slug}`}
                class="blog-post group block p-6 rounded-xl border border-gray-800 hover:border-gray-700 bg-black/40 hover:bg-white/5 transition-all duration-200"
                data-category={post.data.category}
              >
                <h2 class="text-2xl font-semibold text-white mb-3 group-hover:text-gray-300 transition-colors">
                  {post.data.title}
                </h2>

                <p class="text-gray-400 mb-4 line-clamp-2">
                  {post.data.description}
                </p>

                <div class="flex items-center gap-2 text-sm text-gray-500">
                  <span>{post.data.category}</span>
                  <span>Â·</span>
                  <span>{formatDate(post.data.date)}</span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  // Category filtering
  const categoryButtons = document.querySelectorAll('.category-filter');
  const blogPosts = document.querySelectorAll('.blog-post');

  categoryButtons.forEach(button => {
    button.addEventListener('click', () => {
      const selectedCategory = button.getAttribute('data-category');

      // Update active state
      categoryButtons.forEach(btn => {
        btn.classList.remove('bg-white/10', 'text-white');
        btn.classList.add('text-gray-400');
      });
      button.classList.add('bg-white/10', 'text-white');
      button.classList.remove('text-gray-400');

      // Filter posts
      blogPosts.forEach(post => {
        const postCategory = post.getAttribute('data-category');
        if (selectedCategory === 'All Posts' || selectedCategory === postCategory) {
          post.classList.remove('hidden');
        } else {
          post.classList.add('hidden');
        }
      });
    });
  });

  // Set "All Posts" as active by default
  const allPostsButton = document.querySelector('.category-filter[data-category="All Posts"]');
  if (allPostsButton) {
    allPostsButton.classList.add('bg-white/10', 'text-white');
    allPostsButton.classList.remove('text-gray-400');
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
